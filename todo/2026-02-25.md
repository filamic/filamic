# TODO — 2026-02-25

## Completed

- [x] **Create Pest test skill** — Wrote `.claude/commands/create-test.md` with Model, Resource, and Action test checklists following the project's AAA pattern.

- [x] **Fix CI blocker — git casing** — `BelongsToSchoolyear.php` → `BelongsToSchoolYear.php` via two-step `git mv` (macOS case-insensitive filesystem).

- [x] **Fix StudentEnrollmentFactory** — Added `configure()` with `afterMaking` to derive `branch_id` and `school_id` from the classroom's school.

- [x] **Fix SchoolYearTest** — Updated 3 tests: deactivation sync (needs enrollment + payment account), activation sync (needs payment account), cache test (uses `getActive()` re-cache).

- [x] **Fix SchoolTermTest** — Updated 3 tests: deactivation keeps students active when school year still active, activation sync needs payment account, cache test uses `getActive()`.

- [x] **Fix StudentTest** — Rewrote 9 tests: `syncActiveStatus` needs enrollment + payment account, replaced removed `hasUnpaidMonthlyFee`/`hasPaidMonthlyFee` methods with HasMany relationship tests, fixed PROMOTED enum reference.

- [x] **Write ClassroomTest from scratch** — 4 tests: mass assignment guard, column casts (grade→GradeEnum, is_moving_class→bool), school relationship, multiple classrooms per school.

- [x] **Write StudentEnrollmentTest from scratch** — 11 tests: mass assignment, casts, active/inactive scopes, isActive method, 5 relationship tests.

- [x] **Uncomment & update ClassroomResourceTest** — 19 tests: list/create/edit/view pages, column rendering, search, filters, form validation with dynamic grade/temp_level dependency.

- [x] **Fix phpunit.xml memory limit** — Added `memory_limit=512M` to prevent OOM during full suite (Filament resource tests accumulate memory across 270+ tests).

## Pending

- [ ] **Add Student status enum** — Implement `StudentStatusEnum` with values: `ACTIVE`, `ALUMNI`, `TRANSFERRED`. Add `status` column to students table via migration, update model casts, factory, and Filament resource filter. Keep `is_active` as the derived computed truth (enrollment source of truth), `status` is the human-facing label.

- [ ] **Implement Middleware Readiness Check** — Create middleware that verifies an active `SchoolYear` AND `SchoolTerm` exist before allowing access to any core feature route. Redirect to a "setup required" page if not. Register in the relevant panel middleware stack.

## Notes

- Branch: `add-finance-module` (current). If adding student status, consider whether it needs its own branch.
- Run `composer analyse && composer test` before any commit.
- Ask before creating new migrations — check if existing ones can be amended (dev only).
